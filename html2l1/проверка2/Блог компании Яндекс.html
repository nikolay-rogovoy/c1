<!DOCTYPE html>
<!-- saved from url=(0097)https://s3.amazonaws.com/coursera-uploads/peer-review/a351ce0d1ba5efdf9b6b9fd4f3f04544/index.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title> Блог компании Яндекс</title>
</head>
<body>

<header>Блог компании Яндекс</header>
<h1>ЯНДЕКС.ПОЧТА: КАК МЫ ИЗМЕРЯЕМ СКОРОСТЬ ЗАГРУЗКИ И УЛУЧШАЕМ ЕЁ</h1>

<main>

    <p> Если ваш сайт медленно грузится, вы рискуете тем, что люди не оценят ни то
        какой он красивый, ни то, какой он удобный. Никому не понравится, когда все
        тормозит.Мы регулярно добавляем в Яндекс.Почту новую функциональность,
        иногда — исправляем ошибки, а это значит, у нас постоянно появляются новый код
        и новая логика. Всё это напрямую влияет на скорость работы интерфейса.</p>

    <h2>Что мы измеряем:</h2>
    <p><b>Этапы первой загрузки:</b></p>
    <ul>
        <li>подготовка;</li>
        <li>загрузка статики (HTTP-запрос и парсинг);</li>
        <li>исполнение модулей;</li>
        <li>инициализация базовых объектов;</li>
        <li>отрисовка.</li>
    </ul>

    <p><b>Этапы отрисовки любой страницы:</b></p>
    <ul>
        <li>подготовка к запросу на сервер;</li>
        <li>запрос данных с сервера;</li>
        <li>шаблонизация;</li>
        <li>обновление DOM.</li>
    </ul>

    <p>
            <q>— «Ок, теперь у нас есть метрики, мы можем отправить их на сервер»<q> <em>- говорим мы</em><br>
            <q>— «Что же дальше?»</q> <em>- вопрошаете вы</em> <br>
            <q>— «А давай построим график!»</q> <em>- отвечаем мы</em><br>
            <q>— «А что будем считать?»</q> <em>- уточняете вы</em> <br>

    </q></q></p>


    <p>Как вы знаете, медиана – это серединное, а не среднее значение в выборке.
        Если у нас имеются числа 1, 2, 2, 3, 8, 10, 20, то медиана – 3, а среднее – 6,5.
        В общем случае медиана отлично показывает, сколько грузится средний пользователь.</p>

    <p>В случае ускорения или замедления медиана, конечно, изменится. Но она не может
        рассказать, сколько пользователей ускорилось, а сколько замедлилось.</p>
    <dt><b>APDEX</b></dt>
    <dd><b>APDEX</b> – метрика, которая сразу говорит: хорошо или плохо. Метрика<br>
        работает очень просто. Мы выбираем временной интервал [0; t], такой, что если<br>
        время показа страницы попало в него, то пользователь счастлив. Берем еще один<br>
        интервал, (t; 4t] (в четыре раза больше первого), и считаем, что если страница<br>
        показана за это время, то пользователь в целом удовлетворен скоростью работы,<br>
        но уже не настолько счастлив. И применяем формулу:<br>
        (кол-во счастливых пользователей + кол-во удовлетворенных / 2) / (кол-во всех).<br>
        Получается значение от нуля до единицы, которое, видимо, лучше всего показывает,<br>
        хорошо или плохо работает почта.<p></p></dd>

    <h3>Как мы измеряем</h3>

    <p>Сейчас модуль обновления сам логирует все свои стадии, и можно легко понять
        причину замедления: медленнее стал отвечать сервер либо слишком долго
        выполняется JavaScript. Выглядит это примерно так:
    </p><p><code>['look-ma-im-start'] = Date.now();<br>
        this.timings['look-ma-finish'] = Date.now();</code></p>

    C помощью Date.now() мы получаем текущее время. Все тайминги собираются и при
    отправке рассчитываются. На этапах разница между “end” и “start” не считается,
    а все вычисления производятся в конце:<br>

    <p><var>var totalTime = this.timings['look-ma-finish'] - this.timings['look-ma-im-start'];</var></p>

    <p>И на сервер прилетают подобные записи:</p>

    <p><code>serverResponse=50&amp;domUpdate=60</code></p>

    <h4>Как мы ускоряем</h4>

    <p>Чтобы снизить время загрузки почты при выходе новых версий,
        мы уже делаем следующее:</p>

    <ul>
        <li>включаем gzip;</li>
        <li>выставляем заголовки кэширования;</li>
        <li>фризим CSS, JS, шаблоны и картинки;</li>
        <li>используем CDN;</li>
    </ul>

    <p>Мы подумали:<q> А что если хранить где-то старую версию файлов, а при выходе новой<br>
        передавать только diff между ней и той, которая сохранена у пользователя?</q><br>
        В браузере же останется просто наложить патч на клиенте.</p>

    <p>На самое деле эта идея не нова. Уже существуют стандарты для <abbr title="HyperText Transfer Protocol — «протокол передачи гипертекста»">HTTP</abbr> — например,
        RFC 3229 «Delta encoding in <abbr title="HyperText Transfer Protocol — «протокол передачи гипертекста»">HTTP</abbr>» и «Google
        <abbr>SDHC</abbr>», — но по разным причинам они
        не получили должного распространения в браузерах и на серверах.</p>

    <p>Мы же решили сделать свой аналог на <abbr title="JavaScript — мультипарадигменный язык программирования.">JS</abbr>. Чтобы реализовать этот метод
        обновления,
        начали искать реализации diff на <abbr title="JavaScript — мультипарадигменный язык программирования.">JS</abbr>.
        На популярных хостингах кода нашли
        библиотеки:</p>
    <dl>
        <dd>- VCDiff</dd>
        <dd>- google-diff-patch-match</dd>
    </dl>


    <p>Для окончательного выбора библиотеки нам нужно сравнить:</p>

    <table border="3" align="center" cellpadding="6" cellspacing="3" bgcolor="#f0ffff">
        <tbody><tr>
            <th>Библиотека</th>
            <th>IE 9</th>
            <th>Opera 12</th>
        </tr>
        <tr>
            <td>vcdiff</td>
            <td>8</td>
            <td>5</td>
        </tr>
        <tr>
            <td>google diff</td>
            <td>1363</td>
            <td>76</td>
    </tr></tbody></table>

    <p>После того как мы определились с библиотекой для диффа, нужно определиться с тем,
        где и как хранить статику на клиенте.</p>

    <p>Формат файла с патчами для проекта выглядит так:<br></p>
    <p>
                                                               <code>
                                                                   </code></p><pre><code>                                                                       [
                                                                         {
                                                                            "k": "jane.css",<br>
                                                                            "p": [patch],<br>
                                                                            "s": 4554<br>
                                                                         },
                                                                         {
                                                                            "k": "jane.css",<br>
                                                                            "p": [patch],<br>
                                                                            "s": 4554<br>
                                                                         }
                                                                       ]
                                                                   </code></pre><code>
                                                               </code>

    <p></p>

    <p>То есть это обычный массив из объектов. Каждый объект — отдельный ресурс. У
        каждого объекта есть три свойства. k — названия ключа в localStorage для этого
        ресурса. p — патч для ресурса, который сгенерировал vcdiff. s — чексумма для
        ресурса актуальной версии, чтобы потом можно было проверить правильность
        наложения патча на клиенте. Чексумма вычисляется по алгоритму Флетчера.</p>

    <dd><b><abbr title="Алгоритм Бройдена — Флетчера — Гольдфарба — Шанно">(BFGS)</abbr></b>
        — итерационный метод численной оптимизации, предназначенный для<br>
        нахождения локального максимума/минимума нелинейного функционала<br>
        без ограничений.
    </dd>

						<strong>дано</strong> <em>ε</em>, x<sub>0</sub><br>
                        инициализировать <em>H<sub>0</sub></em>
						<br><em>k</em>=0
						<br><strong>while</strong> ||∇ƒ<sub><em>k</em></sub> || &gt; <em>ε</em>
						<br>&nbsp;&nbsp;найти направлени <em>p<sub>k</sub></em> = - <em>C<sub>k</sub></em>∇ƒ<sub><em>k</em></sub>
						<br>&nbsp;&nbsp;вычислить <em>x</em><sub><em>k</em>+1</sub> = <em>x<sub>k</sub></em> + <em>α<sub>k</sub>p<sub>k</sub></em>, <em>α<sub>k</sub></em> удовлетворяет условиям Вольфе
						<br>&nbsp;&nbsp;обозначить <em>s<sub>k</sub></em> = <em>x</em><sub><em>k</em>+1</sub> - <em>x<sub>k</sub></em> и <em>y<sub>k</sub></em> = ∇ƒ<sub><em>k</em>+1</sub> - ∇ƒ<sub><em>k</em></sub>
						<br>&nbsp;&nbsp;вычислить <em>C</em><sub><em>k</em>+1</sub>
						<br>&nbsp;&nbsp;<em>k</em> = <em>k</em> + 1
						<br><strong>end</strong>

    <!--<p><img src="C:\Users\alex\Desktop\algoritm.png" title="Алгоритм Бройдена — Флетчера — Гольдфарба — Шанно (BFGS)"
            width="600" alt=""></p>-->

    <p>Почему именно алгоритм Флетчера, а не другие популярные алгоритмы вроде:<br>
        </p><dt>CRC16/32</dt>
    <dd>CRC16/32 - алгоритм нахождения контрольной суммы, предназначенный для проверки
        целостности данных
    </dd>
    <dt>md5</dt>
    <dd>md5 - 128-битный алгоритм хеширования. Предназначен для создания «отпечатков»<br>
        или дайджестов сообщения произвольной длины и последующей проверки<br>
        их подлинности.
    </dd>

    <p>Потому что он быстрый, компактный и легок в реализации.</p>

    <h5>Итог</h5>

    <p>Фактически мы экономим 80-90% трафика. Размер загружаемой статитки в байтах:</p>

    <table border="3" align="center" cellpadding="6" cellspacing="3" summary="Размер загружаемой статитки в байтах" bgcolor="#f0ffff">
        <tbody><tr>
            <th>Релиз</th>
            <th>С патчем</th>
            <th>Без патча</th>
        </tr>
        <tr>
            <td>7.7.20</td>
            <td>397</td>
            <td>174 549</td>
        </tr>
        <tr>
            <td>7.7.21</td>
            <td>383</td>
            <td>53 995</td>
        </tr>
        <tr>
            <td>7.7.22</td>
            <td>483</td>
            <td>3 995</td>
    </tr></tbody></table>

    <address>
        <p> Автор: @doochik<br>
            С++ разработчик<br>
            Электронная почта:<cite><a href="malto:doochik@yandex-team.ru">(doochik@yandex-team.ru)</a></cite></p><br>
        Компания: Яндекс<br>
        <p></p>
    </address>

    <section>
        <p>Комментарии (3):</p>

        <article>
            <p><em>-Mogaika</em><cite><a href="malto:mogaika@yandex-team.ru">(mogaika@yandex-team.ru)</a></cite>
                <time>30 ноября 2014 в 17:05</time>
                <br>
            </p><blockquote><q>А можете привести сравнение, на сколько быстрее грузится lite версия?</q></blockquote>
            <p></p>
        </article>

        <article>
            <p><cite><em>- JIguse</em><cite><a href="malto:mrawesome@yandex.ru"> (mrawesome@yandex.ru)</a></cite>
                <time>29 ноября 2014 в 21:30</time>
                <br>
                </cite></p><blockquote><q> Спасибо за статью, познавательно. Здорово, что Яндекс делится некоторыми
                    подробностями о внутренней работе сервисов.</q></blockquote>
            <p></p>

            <p><cite><em>- Brister</em><cite> <a href="malto:brist89@yandex-team.ru">(brist89@yandex-team.ru)</a></cite>
                <time>24 ноября 2014 в 13:13</time>
                <br>
                </cite></p><blockquote><q>(кол-во счастливых пользователей + кол-во удовлетворенных / 2) / (кол-во всех).<br>
                    Получается значение от нуля до единицы, которое, видимо, лучше всего показывает,<br>
                    хорошо или плохо работает почта.<br>
                    наверное все-таки от 0.5 до 1</q></blockquote>
            <p></p>
        </article>

        <article>
            <p><em>- alexeimois</em><cite><a href="malto:test@yandex.ru">(test@yandex.ru)</a></cite>
                <time>22 ноября 2014 в 17:35</time>
                <br>
            </p><blockquote><q>Мы измеряем скорость загрузки с помощью Яндекс.Метрики:</q><br>
                <cite><a href="https://s3.amazonaws.com/coursera-uploads/peer-review/a351ce0d1ba5efdf9b6b9fd4f3f04544/(malto:help.yandex.ru/metrika/reports/monitoring_timing.xml)">help.yandex.ru/metrika/reports/monitoring_timing.xml</a></cite>
            </blockquote>
            <p></p>
        </article>
    </section>

</main>

<footer>
    <address><em>© Яндекс,<cite><a href="malto:help@yandex.ru">help@yandex.ru</a></cite>, Хохрякова, 10</em></address>
</footer>


</body></html>